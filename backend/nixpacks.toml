[phases.setup]
nixPkgs = ["nodejs-18_x", "python310", "python310Packages.pip", "python310Packages.setuptools", "python310Packages.wheel"]

[phases.install]
cmds = [
  "bash cleanup-large-files.sh",
  "bash download-models.sh",
  "npm install --production",
  "npm cache clean --force",
  "python3 -m venv --without-pip venv || python3 -m venv venv",
  "source venv/bin/activate",
  "curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py",
  "venv/bin/python3 /tmp/get-pip.py --break-system-packages || venv/bin/python3 /tmp/get-pip.py",
  "venv/bin/pip install --upgrade pip setuptools wheel",
  "venv/bin/pip install --no-cache-dir -r requirements-core.txt",
  "venv/bin/pip install --no-cache-dir -r requirements-ml.txt",
  "venv/bin/pip cache purge",
  "rm -rf /tmp/get-pip.py",
  "find . -type d -name '__pycache__' -exec rm -r {} + || true",
  "find . -type f -name '*.pyc' -delete || true",
  "find . -type f -name '*.pyo' -delete || true",
  "du -sh . || true"
]

[start]
cmd = "bash start.sh"

